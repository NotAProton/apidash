name: "Build and release"

on:
  workflow_dispatch:
    inputs:
      draft:
        description: "Draft release"
        required: true
        type: boolean
      version:
        description: "Desired version number"
        required: true
        type: string
      release-notes:
        description: "Release notes"
        required: false
        type: string
permissions:
  contents: read

jobs:
  build-for-amd64:
    runs-on: "ubuntu-22.04"

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get install clang cmake git ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libjsoncpp-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter doctor -v

      - name: Flutter build
        run: flutter build linux --release -v -d

      - name: Tar bundle
        run: tar -czvf build/linuxAmd64-$(echo ${{ github.event.inputs.version }}).tar.gz build/linux/release/bundle

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: build/linuxAmd64-$(echo ${{ github.event.inputs.version }}).tar.gz
          fail_on_unmatched_files: true
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ github.event.inputs.version }}
          body: "${{ github.event.inputs.release-notes }}"
